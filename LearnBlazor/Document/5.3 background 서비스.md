# Background 서비스 

ASP.NET Core 서버에서 계속 실행되어 뭔가를 실행할 수 있는 서비스가 필요한 경우가 
꽤 있어 보인다. RabbitMQ의 응답을 기다려서 정보를 기록하고 이를 전달하거나 하는 
경우가 대표적이고, 일정 시간이 되면 수행하는 예약 작업 처리 기능도 이와 같은 
서비스가 있어야 가능하다. 

## 용례 중심 설명

[background 서비스 설명](https://wildermuth.com/2022/05/04/using-background-services-in-asp-net-core/)


- Channel<T> 기반의 큐 서비스 
  - builder.Services.AddSingleton<IAccumulatorQueue,AccumulatorQueue>()

- IHostedService
  - StartAsync() 
  - StopAsync() 
  - .NET에서 시작한다. 
  - builder.Services.AddHostedService<SERVICENAME>()

- BackgroundService : IHostedService 
  - abstract Task ExecuteAsync()

- AccumulatorBackgroundService 
  - override ExecuteAsync() 
  - 여기서 쓰레드 처럼 루프를 돌면서 처리 
  - 종료는 토큰으로 정보를 전달한다. 


using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
using Microsoft.Extensions.Logging;

namespace ShawnLink.Services;

public class AccumulatorBackgroundService : BackgroundService
{
  private readonly ILogger<AccumulatorBackgroundService> _logger;
  private readonly IAccumulatorQueue _queue;
  private readonly IServiceProvider _service;

  public AccumulatorBackgroundService(ILogger<AccumulatorBackgroundService> logger, 
    IAccumulatorQueue queue, 
    IServiceProvider service)
  {
    _logger = logger;
    _queue = queue;
    _service=service;
  }

```c#
protected async override Task ExecuteAsync(CancellationToken stoppingToken)
{
  while (!stoppingToken.IsCancellationRequested)
  {
    try
    {
      var redirect = await _queue.PullAsync(stoppingToken);

      _logger.LogInformation($"Processing Redirection for {redirect.Key}");

      using var scope = _service.CreateScope();
      var repo = scope.ServiceProvider.GetService<ILinkRepository>();
      await repo.InsertRedirect(redirect);

    }
    catch (Exception ex)
    {
      _logger.LogError($"Failure while processing queue {ex}");
    }
    }
}

public override async Task StopAsync(CancellationToken cancellationToken)
{
  _logger.LogInformation("Stopping Background Service");
  await base.StopAsync(cancellationToken);
}
```

## 연습 

직접 백그라운드 서비스를 하나 만들고 처리한다. 



